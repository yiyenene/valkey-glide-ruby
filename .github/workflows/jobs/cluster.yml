name: Cluster Tests

on:
  workflow_call:

jobs:
  test:
    runs-on: ubuntu-latest
    name: Cluster / Ruby ${{ matrix.ruby }} Valkey ${{ matrix.valkey }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        ruby:
          - 3.4
        valkey:
          - 7
          - 8
          - 9

    steps:
      - uses: actions/checkout@v4
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby }}
          bundler-cache: true

      - name: Start Valkey cluster nodes
        env:
          VALKEY_VERSION: ${{ matrix.valkey }}
        run: |
          echo "=== Starting Valkey cluster nodes (version ${{ matrix.valkey }}) ==="
          docker compose -f .github/docker-compose.cluster.yml up -d
          echo "=== Waiting for all nodes to be healthy ==="
          sleep 10

      - name: Initialize Valkey cluster
        env:
          VALKEY_VERSION: ${{ matrix.valkey }}
        run: |
          echo "=== Creating Valkey cluster ==="
          docker exec valkey-cluster-1 valkey-cli --cluster create \
            valkey-cluster-1:7000 \
            valkey-cluster-2:7001 \
            valkey-cluster-3:7002 \
            valkey-cluster-4:7003 \
            valkey-cluster-5:7004 \
            valkey-cluster-6:7005 \
            --cluster-replicas 1 \
            --cluster-yes

      - name: Wait for cluster to be ready
        run: |
          echo "=== Waiting for Valkey cluster to be fully ready ==="
          max_attempts=60
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt/$max_attempts: Checking cluster state..."
            
            # Check if all nodes are responding
            all_nodes_up=true
            for i in 1 2 3 4 5 6; do
              container="valkey-cluster-$i"
              port=$((6999 + i))
              if ! docker exec $container valkey-cli -p $port ping > /dev/null 2>&1; then
                echo "  Container $container (port $port) is not responding"
                all_nodes_up=false
                break
              fi
            done
            
            if [ "$all_nodes_up" = true ]; then
              # Check cluster state
              cluster_state=$(docker exec valkey-cluster-1 valkey-cli -p 7000 cluster info | grep "cluster_state" | cut -d: -f2 | tr -d '\r')
              echo "  Cluster state: $cluster_state"
              
              if [ "$cluster_state" = "ok" ]; then
                echo "✅ Cluster is ready!"
                break
              fi
            fi
            
            echo "  Cluster not ready yet, waiting 5 seconds..."
            sleep 5
            attempt=$((attempt + 1))
          done
          
          if [ $attempt -gt $max_attempts ]; then
            echo "❌ Cluster failed to become ready within timeout"
            echo "=== Final cluster info ==="
            docker exec valkey-cluster-1 valkey-cli -p 7000 cluster info || echo "Failed to get cluster info"
            echo "=== Cluster nodes ==="
            docker exec valkey-cluster-1 valkey-cli -p 7000 cluster nodes || echo "Failed to get cluster nodes"
            exit 1
          fi

      - name: Run cluster tests
        run: bundle exec rake test:cluster
        timeout-minutes: 25

      - name: Cleanup cluster
        if: always()
        env:
          VALKEY_VERSION: ${{ matrix.valkey }}
        run: |
          echo "=== Stopping Valkey cluster ==="
          docker compose -f .github/docker-compose.cluster.yml down -v
